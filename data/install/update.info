INFO
====
Watch out for database role in SQLs and change "openatlas_master" if needed.

1.6.0 to 2.0.0 Upgrade
======================

BEGIN;

ALTER SCHEMA crm RENAME TO model;

CREATE TABLE web.form (
    id integer NOT NULL,
    name text NOT NULL,
    created timestamp without time zone DEFAULT now() NOT NULL,
    modified timestamp without time zone
);
ALTER TABLE web.form OWNER TO openatlas_master;
CREATE SEQUENCE web.form_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
ALTER TABLE web.form_id_seq OWNER TO openatlas_master;
ALTER SEQUENCE web.form_id_seq OWNED BY web.form.id;

CREATE TABLE web.node (
    id integer NOT NULL,
    entity_id integer NOT NULL,
    name text NOT NULL,
    multiple integer DEFAULT 0 NOT NULL,
    is_extendable integer DEFAULT 0 NOT NULL,
    is_directional integer DEFAULT 0 NOT NULL,
    created timestamp without time zone DEFAULT now() NOT NULL,
    modified timestamp without time zone,
    system integer DEFAULT 0 NOT NULL
);
ALTER TABLE web.node OWNER TO openatlas_master;
COMMENT ON COLUMN web.node.name IS 'same as model.entity.name, to ensure unique root node names';
COMMENT ON COLUMN web.node.multiple IS 'if 1 multiple selection is possible';
COMMENT ON COLUMN web.node.system IS 'if 1 it is a non deleteable predefined node';
CREATE SEQUENCE web.node_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
ALTER TABLE web.node_id_seq OWNER TO openatlas_master;
ALTER SEQUENCE web.node_id_seq OWNED BY web.node.id;

CREATE TABLE web.node_form (
    id integer NOT NULL,
    node_id integer NOT NULL,
    form_id integer NOT NULL,
    created timestamp without time zone DEFAULT now() NOT NULL,
    modified timestamp without time zone
);
ALTER TABLE web.node_form OWNER TO openatlas_master;
CREATE SEQUENCE web.node_form_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
ALTER TABLE web.node_form_id_seq OWNER TO openatlas_master;
ALTER SEQUENCE web.node_form_id_seq OWNED BY web.node_form.id;

ALTER TABLE ONLY web.node ALTER COLUMN id SET DEFAULT nextval('web."node_id_seq"'::regclass);
ALTER TABLE ONLY web.form ALTER COLUMN id SET DEFAULT nextval('web."form_id_seq"'::regclass);
ALTER TABLE ONLY web.node_form ALTER COLUMN id SET DEFAULT nextval('web."node_form_id_seq"'::regclass);
ALTER TABLE ONLY web.form ADD CONSTRAINT form_name_key UNIQUE (name);
ALTER TABLE ONLY web.form ADD CONSTRAINT form_pkey PRIMARY KEY (id);
ALTER TABLE ONLY web.node ADD CONSTRAINT node_pkey PRIMARY KEY (id);
ALTER TABLE ONLY web.node_form ADD CONSTRAINT node_form_pkey PRIMARY KEY (id);
CREATE TRIGGER update_modified BEFORE UPDATE ON web.node FOR EACH ROW EXECUTE PROCEDURE model.update_modified();
CREATE TRIGGER update_modified BEFORE UPDATE ON web.form FOR EACH ROW EXECUTE PROCEDURE model.update_modified();
CREATE TRIGGER update_modified BEFORE UPDATE ON web.node_form FOR EACH ROW EXECUTE PROCEDURE model.update_modified();
ALTER TABLE ONLY web.node ADD CONSTRAINT node_entity_id_fkey FOREIGN KEY (entity_id) REFERENCES model.entity(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY web.node_form ADD CONSTRAINT node_form_form_id_fkey FOREIGN KEY (form_id) REFERENCES web.form(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY web.node_form ADD CONSTRAINT node_form_node_id_fkey FOREIGN KEY (node_id) REFERENCES web.node(id) ON UPDATE CASCADE ON DELETE CASCADE;

INSERT INTO web.node (entity_id, name, multiple, system, is_extendable, is_directional) VALUES
((SELECT id FROM model.entity WHERE name='Original Document'), 'Original Document', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Source'), 'Source', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Event'), 'Event', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Actor Actor Relation'), 'Actor Actor Relation', 0, 1, 1, 1),
((SELECT id FROM model.entity WHERE name='Actor Function'), 'Actor Function', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Involvement'), 'Involvement', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Gender'), 'Gender', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Site'), 'Site', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Information Carrier'), 'Information Carrier', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Bibliography'), 'Bibliography', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Edition'), 'Edition', 0, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Date value type'), 'Date value type', 0, 1, 0, 0),
((SELECT id FROM model.entity WHERE name='Linguistic object classification'), 'Linguistic object classification', 0, 1, 0, 0),
((SELECT id FROM model.entity WHERE name='Administrative Unit'), 'Administrative Unit', 1, 1, 1, 0),
((SELECT id FROM model.entity WHERE name='Historical Place'), 'Historical Place', 1, 1, 1, 0);

INSERT INTO web.form (name) VALUES
('Source'),
('Event'),
('Person'),
('Group'),
('Legal Body'),
('Place'),
('Bibliography'),
('Edition'),
('Information Carrier');

UPDATE model.link SET property_id = (SELECT id FROM model.property WHERE code = 'P127')
WHERE range_id = (SELECT id FROM model.entity WHERE name = 'Date value type') AND
property_id = (SELECT id FROM model.property WHERE code = 'P86');

COMMIT;

1.4.0 to 1.5.0 Upgrade
======================
SET search_path = web;
CREATE TABLE user_bookmarks (
    id integer NOT NULL,
    user_id integer NOT NULL,
    entity_id integer NOT NULL,
    created timestamp without time zone DEFAULT now() NOT NULL,
    modified timestamp without time zone
);
ALTER TABLE user_bookmarks OWNER TO openatlas_master;
CREATE SEQUENCE user_bookmarks_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
ALTER TABLE user_bookmarks_id_seq OWNER TO openatlas_master;
ALTER SEQUENCE user_bookmarks_id_seq OWNED BY user_bookmarks.id;
ALTER TABLE ONLY user_bookmarks ALTER COLUMN id SET DEFAULT nextval('user_bookmarks_id_seq'::regclass);
ALTER TABLE ONLY user_bookmarks ADD CONSTRAINT user_bookmarks_pkey PRIMARY KEY (id);
ALTER TABLE ONLY user_bookmarks ADD CONSTRAINT user_bookmarks_user_id_entity_id_key UNIQUE (user_id, entity_id);
CREATE TRIGGER update_modified BEFORE UPDATE ON user_bookmarks FOR EACH ROW EXECUTE PROCEDURE crm.update_modified();
ALTER TABLE ONLY user_bookmarks ADD CONSTRAINT user_bookmarks_entity_id_fkey FOREIGN KEY (entity_id) REFERENCES crm.entity(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY user_bookmarks ADD CONSTRAINT user_bookmarks_user_id_fkey FOREIGN KEY (user_id) REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;


1.3.0 to 1.4.0 Upgrade
======================
ALTER TABLE web.user DROP COLUMN phone;
INSERT INTO web.settings ("group", name, value) VALUES ('general', 'default_table_rows', '20');
UPDATE crm.entity SET name = 'Bibliography' WHERE name = 'Bibliographic Item';
DELETE FROM crm.entity WHERE name IN('Evidence', 'History', 'Written Source', 'Historiography', 'Archaeology', 'Excavation', 'Strayfind', 'Spolia', 'Ruins', 'Archaeological Prospection', 'Aerial Photography', 'Geoprospection', 'Survey');


1.2.0 to 1.3.0 Upgrade
======================
Remove obsolete gis point types (and links):
DELETE FROM crm.entity WHERE name IN ('Localisation Quality', 'Exact position', 'Near to a known position', 'Within a known area');


1.1.0 to 1.2.0 Upgrade
======================

Many changes in config files (/application/configs/*).
Better take new ones and change settings as needed.


1.0.1 to 1.1.0 Upgrade
======================

BEGIN;

INSERT INTO web.group (name) VALUES ('readonly'), ('manager');

INSERT INTO crm.entity (class_id, name) VALUES ((SELECT id FROM crm.class WHERE code='E55'), 'Source Transliteration');
INSERT INTO crm.link (property_id, range_id, domain_id) VALUES
((SELECT id FROM crm.property WHERE code='P127'), (SELECT id FROM crm.entity WHERE name='Linguistic object classification'), (SELECT id FROM crm.entity WHERE name='Source Transliteration'));

INSERT INTO crm.entity (class_id, name) VALUES
((SELECT id FROM crm.class WHERE code='E55'), 'Information Carrier'),
((SELECT id FROM crm.class WHERE code='E55'), 'Original Document'),
((SELECT id FROM crm.class WHERE code='E55'), 'Copy of Document');

INSERT INTO crm.link (property_id, range_id, domain_id) VALUES
((SELECT id FROM crm.property WHERE code='P127'), (SELECT id FROM crm.entity WHERE name='Information Carrier'), (SELECT id FROM crm.entity WHERE name='Original Document')),
((SELECT id FROM crm.property WHERE code='P127'), (SELECT id FROM crm.entity WHERE name='Information Carrier'), (SELECT id FROM crm.entity WHERE name='Copy of Document'));

INSERT INTO web.content (id) VALUES (5);

INSERT INTO web.i18n (field, text, item_id, language_id) VALUES
('title', 'FAQ', 5, 2),
('text', '<p>FAQ</p>', 5, 2),
('title', 'FAQ', 5, 1),
('text', '<p>FAQ</p>', 5, 1);

DELETE FROM web.content WHERE id IN (2,4);

COMMIT;
